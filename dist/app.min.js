var App={};(function(t){var e={subscribers:{any:[]},on:function(t,e,o){t=t||"any",e="function"==typeof e?e:o[e],this.subscribers[t]===void 0&&(this.subscribers[t]=[]),this.subscribers[t].push({fn:e,context:o||this})},off:function(t,e,o){this.eachSubscriber("unsubscribe",t,e,o)},fire:function(t,e){this.eachSubscriber("publish",t,e)},eachSubscriber:function(t,e,o,n){var i,l=e||"any",r=this.subscribers[l],c=r?r.length:0;for(i=0;c>i;i++)"publish"===t?r[i].fn.call(r[i].context,o):r[i].fn===o&&r[i].context===n&&r.splice(i,1)}};t.Events=e})(App),function(t,e){function o(t){for(var o in t)this[o]=t[o];this.selection=[],e.on("click:pixel",this.stroke,this),e.on("clear:canvas",this.clearCanvas,this),e.on("pick:stroke",this.clearSelection,this),e.on("mouseleave:canvas",this.undoSelection,this)}o.prototype.singleStroke=function(t,e,o){t.set({color:o}),e.el.style.backgroundColor=o},o.prototype.multiStroke=function(t,e,o){if(!this.selection.length)return this.selection.push(e),e.el.style.backgroundColor=o,void 0;var n=this.selection[0].model;n.isInLineWith(t)?(this.selection=this.getLinearSelection(n,t),this.selection.forEach(function(t){t.model.set({color:o}),t.el.style.backgroundColor=o}),this.clearSelection()):this.undoSelection()},o.prototype.fillStroke=function(t,e){this.selectAllNearbyByColour(t,e),this.selection.forEach(function(t){t.model.set({color:e}),t.el.style.backgroundColor=e}),this.clearSelection()},o.prototype.selectAllNearbyByColour=function(t,e){function o(t){var e=[],o=t.model,n=l.last().model,i=(o.get("col"),o.get("col")-1),c=o.get("col")+1,s=n.get("col"),a=(o.get("row"),o.get("row")-1),u=o.get("row")+1,p=n.get("row");i=0>=i?0:i,c=c>=s?s:c,a=0>=a?0:a,u=u>=p?p:u;var f,h;for(h=a;u>=h;h++)for(f=i;c>=f;f++)e.push(r.getPixelByCoords(h,f));return e}function n(e){return e.model.get("color")===t.model.get("color")}function i(t){return-1===r.selection.indexOf(t)}var l=this.pixelViewCollection,r=this,c=o(t),s=c.filter(n),a=s.filter(i);this.selection=this.selection.concat(a),a.forEach(function(t){r.selectAllNearbyByColour(t,e)})},o.prototype.getPixelByCoords=function(t,e){return this.pixelViewCollection.where(function(o){return o.model.get("row")===t&&o.model.get("col")===e})},o.prototype.getLinearSelection=function(t,e){var o,n,i,l=[];if(t.get("row")===e.get("row")){for(i=t.get("row"),n=t.get("col")<e.get("col")?t.get("col"):e.get("col"),o=t.get("col")>e.get("col")?t.get("col"):e.get("col");o>=n;)l.push(this.getPixelByCoords(i,n++));return l}if(t.get("col")===e.get("col")){for(n=t.get("col"),i=t.get("row")<e.get("row")?t.get("row"):e.get("row"),o=t.get("row")>e.get("row")?t.get("row"):e.get("row");o>=i;)l.push(this.getPixelByCoords(i++,n));return l}},o.prototype.stroke=function(t){var e,o=this.paletteModel.get("color"),n=this.paletteModel.get("strokeType");switch(this.pixelViewCollection.forEach(function(o){o.model===t&&(e=o)}),n){case"single":this.singleStroke(t,e,o);break;case"multi":this.multiStroke(t,e,o);break;case"fill":this.fillStroke(e,o)}},o.prototype.clearCanvas=function(){this.pixelViewCollection.forEach(function(t){t.model.set({color:"#ffffff"}),t.el.style.backgroundColor="#ffffff"}),e.fire("pick:stroke","single")},o.prototype.clearSelection=function(){this.selection=[]},o.prototype.undoSelection=function(){"multi"===this.paletteModel.get("strokeType")&&(this.selection.forEach(function(t){t.el.style.backgroundColor=t.model.get("color")}),this.clearSelection())},t.Mediator=o}(App,App.Events),function(t){function e(t){this.attrs={},this.set(t)}e.prototype.get=function(t){return this.attrs[t]!==void 0?this.attrs[t]:null},e.prototype.toJSON=function(){return this.attrs},e.prototype.set=function(t){for(var e in t)this.attrs[e]=t[e]},t.Model=e}(App),function(t,e,o){function n(){var t=new e({color:"#000000",strokeType:"single"});return o.on("select:color",function(e){t.set({color:e})}),o.on("pick:stroke",function(e){t.set({strokeType:e})}),t}t.PaletteModel=n}(App,App.Model,App.Events),function(t,e){function o(t){return document.getElementById(t)}function n(n){var i=new t.View(n);return i.addEventListeners=function(){document.addEventListener?(o("select-color").addEventListener("change",this.selectColor,this),o("btn-single").addEventListener("click",this.pickSingle,this),o("btn-multi").addEventListener("click",this.pickMulti,this),o("btn-fill").addEventListener("click",this.pickFill,this),o("btn-clear").addEventListener("click",this.clearCanvas,this)):(o("select-color").attachEvent("onchange",this.selectColor,this),o("btn-single").attachEvent("onclick",this.pickSingle),o("btn-multi").attachEvent("onclick",this.pickMulti),o("btn-fill").attachEvent("onclick",this.pickFill),o("btn-clear").attachEvent("onclick",this.clearCanvas))},i.selectColor=function(t){var o=t.target?t.target.value:t.srcElement.value;e.fire("select:color",o)},i.pickSingle=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1,e.fire("pick:stroke","single")},i.pickMulti=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1,e.fire("pick:stroke","multi")},i.pickFill=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1,e.fire("pick:stroke","fill")},i.clearCanvas=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1,e.fire("clear:canvas")},i.selectButton=function(t){var e=document.querySelector(".selected");e&&(e.className=""),o("btn-"+t).className="selected"},e.on("pick:stroke",i.selectButton),i}t.PaletteView=n}(App,App.Events),function(t,e){function o(t){var o=new e(t);return o.set({color:"#ffffff"}),o.isInLineWith=function(t){return o.get("row")===t.get("row")||o.get("col")===t.get("col")},o}t.PixelModel=o}(App,App.Model,App.Events),function(t,e){function o(o){var n=new t.View(o);return n.onClick=function(){n.model,e.fire("click:pixel",n.model)},n.addEventListeners=function(){n.el.addEventListener?n.el.addEventListener("click",n.onClick):n.el.attachEvent("onclick",n.onClick)},n}t.PixelView=o}(App,App.Events),function(t){function e(t){for(var e in t)this[e]=t[e]}e.prototype.render=function(){return this.el||(this.el=document.createElement(this.tagName||"div"),this.el.className=this.className||""),this.template&&(this.el.innerHTML="",this.el.appendChild(this.template())),this},t.View=e}(App),function(t){function e(){this.items=[]}e.prototype.push=function(t){this.items.push(t)},e.prototype.forEach=function(t){this.items.forEach(t)},e.prototype.get=function(t){var e=[];return this.items.forEach(function(o){for(var n in t)""+o.get(n)==""+t[n]&&e.push(o)}),e},e.prototype.last=function(){return this.items[this.items.length-1]},e.prototype.where=function(t){for(var e=0,o=this.items.length;o>e;e++)if(t(this.items[e]))return this.items[e]},e.prototype.sortBy=function(t){return this.items.sort(function(e,o){return o.get(t)-e.get(t)}),this},e.prototype.sort=function(t){return this.items.sort(t),this},t.Collection=e}(App),function(t){var e={palette:function(){var t='<button id="btn-clear">Clear</button><button id="btn-single" class="selected">Single</button><button id="btn-multi">Multi</button><button id="btn-fill">Fill</button><select id="select-color" name="select-color"><option selected="selected" value="#000000">Black</option><option value="#0000AA">Blue</option><option value="#00AA00">Green</option><option value="#00AAAA">Cyan</option><option value="#AA0000">Red</option><option value="#AA00AA">Magenta</option><option value="#AA5500">Brown</option><option value="#AAAAAA">Light Grey</option><option value="#555555">Dark Grey</option><option value="#5555FF">Bright Blue</option><option value="#55FF55">Bright Green</option><option value="#55FFFF">Bright Cyan</option><option value="#FF5555">Bright Red</option><option value="#FF55FF">Bright Magenta</option><option value="#FFFF55">Bright Yellow</option><option value="#FFFFFF">Bright White</option></select>',e=document.createElement("form");return e.innerHTML=t,e}};t.Templates=e}(App),function(t){function e(e,o){var n,i,c,s,a=document.createDocumentFragment();for(i=0;o>i;i++)for(n=0;e>n;n++)c=new t.PixelModel({row:i,col:n}),s=new t.PixelView({model:c,tagName:"li"}),l.push(c),r.push(s),a.appendChild(s.render().el),s.addEventListeners();return a}var o=new t.View({el:document.querySelector(".paint")}),n=new t.PaletteModel,i=new t.PaletteView({className:"palette",template:t.Templates.palette,model:n}),l=new t.Collection,r=new t.Collection;new t.Mediator({paletteModel:n,pixelViewCollection:r}),t.start=function(){var n=o.el.getAttribute("data-m"),l=o.el.getAttribute("data-n"),r=e(n,l),c=document.createElement("ul");o.el.appendChild(i.render().el),i.addEventListeners(),o.el.appendChild(c),c.appendChild(r),c.style.width=n*(c.children[0].clientWidth+1)+1+"px",c.addEventListener?c.addEventListener("mouseleave",function(){t.Events.fire("mouseleave:canvas")}):c.attachEvent("onmouseleave",function(){t.Events.fire("mouseleave:canvas")})}}(App),App.start();